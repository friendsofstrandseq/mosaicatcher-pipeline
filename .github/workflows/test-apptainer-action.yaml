name: Test Apptainer with Official Action

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  test-with-official-action:
    name: Test with setup-apptainer action
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Git Submodule Update
        run: |
          git submodule update --remote --recursive --force --init

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.3
        with:
          pixi-version: latest
          cache: true
          locked: false

      - name: Setup Apptainer with official action
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: 1.3.0

      - name: Verify Apptainer installation
        run: |
          apptainer --version

      - name: Cache Apptainer SIF
        uses: actions/cache@v4
        with:
          path: |
            mosaicatcher-pipeline_hg38-v2.4.0-beta.2.sif
            ~/.apptainer/cache
          key: apptainer-sif-action-v2.4.0-beta.2
          restore-keys: |
            apptainer-sif-action-

      - name: Log in to GitHub Container Registry for Apptainer
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "${{ secrets.GITHUB_TOKEN }}" | apptainer remote login -u ${{ github.actor }} --password-stdin oras://ghcr.io

      - name: Pull hg38 container for validation
        env:
          APPTAINER_DOCKER_USERNAME: ${{ github.actor }}
          APPTAINER_DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          apptainer pull docker://ghcr.io/friendsofstrandseq/mosaicatcher-pipeline:hg38-v2.4.0-beta.2

      - name: Test container with simple command
        run: |
          apptainer exec mosaicatcher-pipeline_hg38-v2.4.0-beta.2.sif conda info --json

      - name: Run save_conda_versions rules with apptainer
        run: |
          pixi run snakemake \
            --cores 1 \
            --sdm conda apptainer \
            --configfile .tests/config/simple_config_mosaicatcher.yaml \
            --apptainer-args "--bind /tmp:/tmp --bind $PWD:$PWD" \
            --apptainer-prefix .snakemake/apptainer \
            -p \
            .tests/data_CHR17/RPE-BM510/config/conda_export/mc_base.yaml \
            .tests/data_CHR17/RPE-BM510/config/conda_export/mc_bioinfo_tools.yaml \
            .tests/data_CHR17/RPE-BM510/config/conda_export/rtools.yaml

      - name: Display generated conda export files
        if: success()
        run: |
          echo "=== mc_base.yaml export (first 30 lines) ==="
          head -30 .tests/data_CHR17/RPE-BM510/config/conda_export/mc_base.yaml
          echo ""
          echo "=== mc_bioinfo_tools.yaml export (first 30 lines) ==="
          head -30 .tests/data_CHR17/RPE-BM510/config/conda_export/mc_bioinfo_tools.yaml
          echo ""
          echo "=== rtools.yaml export (first 30 lines) ==="
          head -30 .tests/data_CHR17/RPE-BM510/config/conda_export/rtools.yaml
          echo ""
          echo "âœ… Conda environment validation PASSED with official action"

      - name: Upload conda export artifacts
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: conda-exports-action-test
          path: .tests/data_CHR17/RPE-BM510/config/conda_export/
          retention-days: 7
