name: MosaiCatcher basic checks

on:
  push:
    branches:
      - "**"
  schedule:
    - cron: "0 0 * * 0"
jobs:
  Formatting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest
          cache: true
          locked: false
          environments: format

      - name: Check Snakemake formatting with snakefmt
        run: |
          pixi run -e format format

  Linting:
    runs-on: ubuntu-latest
    needs: Formatting
    steps:
      - name: Checkout repository without submodules
        uses: actions/checkout@v4

      - name: List contents of .tests-mock
        run: |
          tree -h github-actions-runner/.tests-mock

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest
          cache: true
          locked: false

      - name: Run Snakemake Lint (v9)
        run: |
          pixi run -e lint snakemake \
            --config data_location=github-actions-runner/.tests-mock/data_CHR17 \
            --lint

  Testing-basic:
    runs-on: ubuntu-latest
    needs:
      - Formatting
      - Linting
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Git Submodule Update
        run: |
          git submodule update --remote --recursive --force --init

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest
          cache: true
          locked: false

      - name: Cache Conda environments
        uses: actions/cache@v4
        with:
          path: .snakemake/conda
          key: conda-envs-${{ hashFiles('workflow/envs/*.yaml') }}
          restore-keys: |
            conda-envs-

      - name: List contents of .tests
        run: |
          tree -h .tests

      - name: Show config file
        run: |
          cat .tests/config/simple_config_mosaicatcher.yaml

      - name: List contents of workflow/data
        run: |
          tree -h workflow/data

      - name: List options of workflow
        run: |
          pixi run snakemake \
            --cores 1 \
            --config list_commands=True

      - name: Run workflow (MosaiCatcher v9)
        run: |
          pixi run snakemake \
            --cores 1 \
            --sdm conda \
            --configfile .tests/config/simple_config_mosaicatcher.yaml \
            --conda-cleanup-pkgs cache \
            -p \
            --snakefile workflow/Snakefile

  Testing-ashleys-basic:
    runs-on: ubuntu-latest
    needs:
      - Formatting
      - Linting
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Git Submodule Update
        run: |
          git submodule update --remote --recursive --force --init

      - name: Setup Pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: latest
          cache: true
          locked: false

      - name: Cache Conda environments
        uses: actions/cache@v4
        with:
          path: .snakemake/conda
          key: conda-envs-${{ hashFiles('workflow/envs/*.yaml') }}
          restore-keys: |
            conda-envs-

      - name: List contents of .tests
        run: |
          tree -h .tests

      - name: Show ashleys config file
        run: |
          cat .tests/config/simple_config_ashleys.yaml

      - name: List ashleys rules
        run: |
          ls -la workflow/rules/ashleys/

      - name: Run workflow (Ashleys basic v9)
        run: |
          pixi run snakemake \
            --cores 1 \
            --sdm conda \
            --configfile .tests/config/simple_config_ashleys.yaml \
            --conda-cleanup-pkgs cache \
            -p \
            --snakefile workflow/Snakefile
